"""FidelFolio_with_result_csv.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Hjy5AC0aLXjLmgaQFzeUiCCK7_VSxmjW
"""

import pandas as pd
import numpy as np
import ast

print('import done')

investment_rules_df = pd.read_csv('input-files/assignment_investment_rules.csv')

print("Investment Rules Dataset:")
investment_rules_df

sector_data_df = pd.read_csv('input-files/assignment_sector_data.csv')

print("Sector/Industry Dataset:")
sector_data_df

mcap_df = pd.read_csv('input-files/assignment_mcap.csv')

print("Market Cap Dataset:")
mcap_df.head(10)

print(sector_data_df.columns)

# Strip any extra spaces or characters from the column names
sector_data_df.columns = sector_data_df.columns.str.strip().str.replace('[', '').str.replace(']', '')

# Check the cleaned column names
print(sector_data_df.columns)

sector_data_df

# Define filtering criteria (examples)
selected_sectors = {"Steel", "Realty", "Construction", "Capital Goods - Non Electrical Equipment", "Capital Goods - Electrical Equipment"}
mcap_rank_range = (1, 500)

# Preprocess Market Capitalization Data
def rank_mcap_per_year(mcap_df):
    ranked_mcap = {}
    for year in mcap_df.columns[1:]:  # Skip 'CO_NAME'
        ranked_mcap[year] = mcap_df[["CO_NAME", year]].dropna().sort_values(by=year, ascending=False)
        ranked_mcap[year]['Rank'] = range(1, len(ranked_mcap[year]) + 1)
    return ranked_mcap

ranked_mcap_data = rank_mcap_per_year(mcap_df)

# Preprocess Sector Data
sector_map = sector_data_df.set_index("CO_NAME")["Sector"].to_dict()

# Function to filter stocks based on sector and market cap ranking
def filter_stocks(stocks, year):
    if pd.isna(stocks):  # Handle NaN values
        return []

    if isinstance(stocks, str):
        try:
            stocks = ast.literal_eval(stocks)  # Convert string to list
        except (SyntaxError, ValueError):
            return []  # Return an empty list if parsing fails

    filtered_stocks = []
    for stock in stocks:
        # Check if stock belongs to the selected sectors
        if stock in sector_map and sector_map[stock] in selected_sectors:
            # Check market cap rank
            if year in ranked_mcap_data and stock in ranked_mcap_data[year]["CO_NAME"].values:
                rank = ranked_mcap_data[year].loc[ranked_mcap_data[year]["CO_NAME"] == stock, "Rank"].values[0]
                if mcap_rank_range[0] <= rank <= mcap_rank_range[1]:
                    filtered_stocks.append(stock)

    return filtered_stocks

# Apply filtering to investment rules
filtered_rules_df = investment_rules_df.copy()
for year in investment_rules_df.columns[1:]:  # Skip 'strat_name'
    filtered_rules_df[year] = investment_rules_df[year].apply(lambda stocks: filter_stocks(stocks, year))

filtered_rules_df

# Compare before and after filtering
sample_year = "2001"  # Change this to any year you want to inspect
print("Before filtering:")
print(investment_rules_df[[sample_year]].head(10))  # Print first 10 rows before filtering

print("\nAfter filtering:")
print(filtered_rules_df[[sample_year]].head(10))  # Print first 10 rows after filtering

sample_year = "2001"

# Extract original stocks and filtered stocks for comparison
original_stocks = investment_rules_df[sample_year].apply(ast.literal_eval)  # Convert from string
filtered_stocks = filtered_rules_df[sample_year]

# Compare
for i in range(10):  # Check first 10 rows
    print(f"Row {i}:")
    print("Before:", original_stocks.iloc[i])
    print("After: ", filtered_stocks.iloc[i])
    print("-" * 50)

output_file = 'output_test.csv'
filtered_rules_df.to_csv(output_file, index=False)
print(f"Filtered investment rules saved to {output_file}")

result_df = pd.read_csv('output_test.csv')

result_df

# testing for some companies
test_data = sector_data_df[sector_data_df['CO_NAME'] == 'Tata Steel']
print(test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'Reliance Infra.']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'JSW Steel']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == "Dr Reddy's Labs"]
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'Hindalco Inds.']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'I O C L']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'Silverline Tech']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'PVP Ventures']
print("\n", test_data)

test_data = sector_data_df[sector_data_df['CO_NAME'] == 'Siemens']
print("\n", test_data)